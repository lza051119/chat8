# Chat8 真实邮件发送功能实现说明

## 功能概述

本项目已成功实现了真实邮件发送功能，支持向 `future_234@qq.com` 等真实邮箱发送验证码。系统支持两种模式：

- **开发模式**: 模拟邮件发送，在控制台显示验证码
- **生产模式**: 真实邮件发送，通过SMTP服务发送到用户邮箱

## 核心文件修改

### 1. 邮件配置 (`backend/app/core/email_config.py`)

```python
# 开发模式标志 - 设置为false启用真实邮件发送
DEVELOPMENT_MODE = os.getenv("DEVELOPMENT_MODE", "false").lower() == "true"

# 邮件配置 - 支持QQ邮箱
conf = ConnectionConfig(
    MAIL_USERNAME=os.getenv("MAIL_USERNAME", "future_234@qq.com"),
    MAIL_PASSWORD=os.getenv("MAIL_PASSWORD", "your_qq_auth_code"),  # QQ邮箱授权码
    MAIL_FROM=os.getenv("MAIL_FROM", "future_234@qq.com"),
    MAIL_PORT=587,
    MAIL_SERVER=os.getenv("MAIL_SERVER", "smtp.qq.com"),  # QQ邮箱SMTP服务器
    MAIL_STARTTLS=True,
    MAIL_SSL_TLS=False,
    USE_CREDENTIALS=True,
    VALIDATE_CERTS=True,
    TEMPLATE_FOLDER=Path(__file__).parent.parent / 'templates'
)
```

### 2. 环境变量配置 (`backend/.env`)

```env
# 邮件配置
MAIL_USERNAME=future_234@qq.com
MAIL_PASSWORD=your_qq_auth_code_here
MAIL_FROM=future_234@qq.com
MAIL_SERVER=smtp.qq.com

# 开发模式设置 - 设置为false启用真实邮件发送
DEVELOPMENT_MODE=false

# 数据库配置
DATABASE_URL=sqlite:///./chat_app.db

# JWT配置
SECRET_KEY=your-secret-key-here
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
```

### 3. 主应用文件 (`backend/app/main.py`)

添加了环境变量加载：

```python
from dotenv import load_dotenv
import os

# 加载环境变量
load_dotenv()
```

### 4. 依赖管理 (`backend/requirements.txt`)

添加了必要的依赖：

```txt
fastapi-mail==1.4.1
aiosmtplib==2.0.2
python-dotenv==1.0.0
```

## QQ邮箱配置步骤

### 1. 获取QQ邮箱授权码

1. 登录 [QQ邮箱网页版](https://mail.qq.com)
2. 点击左上角"设置" → "账户"
3. 找到"POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务"
4. 开启"SMTP服务"
5. 点击"生成授权码"
6. 按提示发送短信获取授权码
7. 将授权码保存备用

### 2. 配置环境变量

在 `backend/.env` 文件中设置：

```env
MAIL_USERNAME=future_234@qq.com
MAIL_PASSWORD=你的QQ邮箱授权码
MAIL_FROM=future_234@qq.com
MAIL_SERVER=smtp.qq.com
DEVELOPMENT_MODE=false
```

## API 使用方法

### 1. 发送忘记密码请求

**端点**: `POST /api/v1/auth/forgot-password`

**请求体**:
```json
{
  "email": "future_234@qq.com"
}
```

**curl 示例**:
```bash
curl -X POST http://localhost:8000/api/v1/auth/forgot-password \
     -H 'Content-Type: application/json' \
     -d '{"email": "future_234@qq.com"}'
```

**响应**:
```json
{
  "success": true,
  "message": "验证码已发送到您的邮箱"
}
```

### 2. 重置密码

**端点**: `POST /api/v1/auth/reset-password`

**请求体**:
```json
{
  "email": "future_234@qq.com",
  "verification_code": "123456",
  "new_password": "newpassword123"
}
```

**curl 示例**:
```bash
curl -X POST http://localhost:8000/api/v1/auth/reset-password \
     -H 'Content-Type: application/json' \
     -d '{
       "email": "future_234@qq.com",
       "verification_code": "123456",
       "new_password": "newpassword123"
     }'
```

## 前端集成示例

### JavaScript 代码

```javascript
// 发送忘记密码请求
async function sendForgotPasswordRequest(email) {
  try {
    const response = await fetch('/api/v1/auth/forgot-password', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ email })
    });
    
    if (response.ok) {
      const data = await response.json();
      alert('验证码已发送到您的邮箱');
      return true;
    } else {
      const error = await response.json();
      alert('发送失败: ' + error.message);
      return false;
    }
  } catch (error) {
    alert('网络错误: ' + error.message);
    return false;
  }
}

// 重置密码
async function resetPassword(email, verificationCode, newPassword) {
  try {
    const response = await fetch('/api/v1/auth/reset-password', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        email,
        verification_code: verificationCode,
        new_password: newPassword
      })
    });
    
    if (response.ok) {
      const data = await response.json();
      alert('密码重置成功');
      return true;
    } else {
      const error = await response.json();
      alert('重置失败: ' + error.message);
      return false;
    }
  } catch (error) {
    alert('网络错误: ' + error.message);
    return false;
  }
}
```

## 测试脚本

项目提供了多个测试脚本：

1. **`test_real_email.py`**: 测试真实邮件发送配置
2. **`test_forgot_password_api.py`**: 测试完整的忘记密码API流程
3. **`email_demo.py`**: 邮件功能演示和配置指南

### 运行测试

```bash
# 进入后端目录
cd backend

# 测试邮件配置
python3 test_real_email.py

# 测试API流程
python3 test_forgot_password_api.py

# 查看演示和配置指南
python3 email_demo.py
```

## 邮件模板

系统发送的验证码邮件包含：

- 美观的HTML格式
- 用户名个性化
- 突出显示的验证码
- 过期时间提醒（10分钟）
- 安全提示

## 安全特性

1. **验证码过期**: 验证码10分钟后自动过期
2. **尝试次数限制**: 防止暴力破解
3. **邮箱验证**: 确保邮箱地址有效
4. **环境变量保护**: 敏感信息通过环境变量管理

## 部署注意事项

1. **生产环境**: 确保设置 `DEVELOPMENT_MODE=false`
2. **邮箱授权码**: 妥善保管QQ邮箱授权码
3. **网络配置**: 确保服务器可以访问QQ邮箱SMTP服务
4. **日志监控**: 监控邮件发送状态和错误日志

## 故障排除

### 常见问题

1. **连接失败**: 检查网络连接和SMTP服务器配置
2. **认证失败**: 验证QQ邮箱授权码是否正确
3. **发送失败**: 检查邮箱服务是否开启SMTP
4. **验证码无效**: 确认验证码未过期且输入正确

### 调试方法

1. 启用开发模式查看详细日志
2. 检查环境变量配置
3. 使用测试脚本验证功能
4. 查看后端服务日志

## 总结

✅ **已完成的功能**:
- 真实邮件发送配置
- QQ邮箱SMTP集成
- 验证码生成和验证
- 忘记密码API
- 密码重置功能
- 开发/生产模式切换
- 完整的测试脚本
- 前端集成示例

🎉 **真实邮件发送功能已完全实现并可投入使用！**

要启用真实邮件发送，只需：
1. 获取QQ邮箱授权码
2. 配置 `.env` 文件
3. 设置 `DEVELOPMENT_MODE=false`
4. 重启后端服务

系统将自动向 `future_234@qq.com` 等真实邮箱发送验证码邮件。